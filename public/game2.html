<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.cdnfonts.com/css/comic-sans" rel="stylesheet">
    <link rel="stylesheet" href="soul_painter/game/style2.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <title>Gaming</title>
</head>
<body>
    <div id="box"> <!-- The block for gaming -->
        <!-- options -->
        <div id="main_block">
            <div id="options">
                <button id="option0" class="option wood2 button">option1</button><br>
                <button id="option1" class="option wood button">option2</button><br>
                <button id="option2" class="option wood2 button">option3</button><br>
                <button id="option3" class="option wood button">option4</button><br>
            </div>
            <span id="waiting" class="wating">
                <h2><b>Waiting...</b></h2>
                <p id="block_status" > 0 / 0 </p>
            </span>
            <div id="result">
                <h2><b>Result</b></h2>
                <p>Ans: <span id="ans"> </span></p>
                <p>&#10004: <span id="num_correct"> </span></p>
                <p>&#10008: <span id="num_wrong"> </span></p>
                <p>Pointy: - <span id="de_boss"> </span></p>
                <p>Squirrel: - <span id="de_player"> </span></p>
            </div>
                
        </div>
        <!-- squirrel -->
        <div id="squirrel">
            <p class="progress-label">squirrel</p>
            <progress value="100" max="100" class="squirrel_hp"></progress>
            <img src="soul_painter/game/squirrel_game.png" id="squirrel_fig">
            <img src="soul_painter/game/acorn1.png" id="pine">
        </div>
        <!-- pointhead -->
        <div id="pointhead">
            <p class="progress-label">pointhead</p>
            <progress value="100" max="100" class="point_hp"></progress>
            <img src="soul_painter/game/patrick_game.png" id="pointhead_fig">
        </div>
        <!-- Questions -->
        <div class="container">
            <img src="soul_painter/game/speechbubble.png" width="200" id = "speechbubble">
            <div class="centered" id="question">Question</div>
        </div>
        <!-- count down progress bar -->
        <progress value="10" max="10" id="pbar" class="progress"></progress>
        <!-- stop watch -->
        <!-- <div id="time">
			<span class="digit" id="min">00</span>
			<span class="digit">:</span>
			<span class="digit" id="sec">00</span>
			<span class="digit">:</span>
			<span class="digit" id="count">00</span>
		</div> -->
    </div>
    <div id="pending"> <!-- The block for pending -->
        <div class="hole"></div>
        <p id="user_mark"> username </p>
        <p class="pending_icon" id="text">Pending......</p>
        <p class="pending_icon" id="pending_status"> 0 / 0 </p>
        <img src="soul_painter/pending/pending-run-unscreen.gif" class="pending_icon">
        <!-- back button -->
        <a href="./menu.html">
            <button class="close">&#x2715</button>
        </a>
    </div>

    <script type="text/javascript" src="//code.jquery.com/jquery-latest.min.js"></script>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
        // run the function upon loaded
        // window.onload=function() {
        // };
        document.getElementById("box").style.display = "none";
        document.getElementById("speechbubble").style.display = "none";
        document.getElementById("waiting").style.display = "none";
        document.getElementById("result").style.display = "none";
        // document.getElementById("pine").style.display = "none";
        
        var click = 0; // click before timeout(boolean)
        var downloadTimer;
        var socket = io.connect();
        var userID = -1, roomID = -1;
        var first_update_username = true;
        $(function() {
            /// for PENDING

            var $pending_status = $("#pending_status");

            socket.on('update num_user', function(num_user, max_user, username) {
                console.log(`${num_user} / ${max_user}`);
                console.log(username);
                $("#pending_status").text(`(${num_user} / ${max_user})`);
                if(first_update_username) $("#user_mark").text(`${username}`);
                first_update_username = false;
            });

            socket.on('update block state', function(num_user, max_user) {
                console.log(`${num_user} / ${max_user}`);
                $("#block_status").text(`(${num_user} / ${max_user})`);
                
            });

            socket.on('game start', function() {
                $('#pending').css("display", "none");
                $('#box').css("display", "block");
                $('#speechbubble').css("display", "block");
                start_countdown();
                // timer=true;
                // stopWatch();
            });


            /// for GAMING

            // var socket = io.connect();
            var $option0 = $('#option0');
            var $option1 = $('#option1');
            var $option2 = $('#option2');
            var $option3 = $('#option3');
            var $question = $('#question');
            var $point_hp = $('.point_hp');
            var $squirrel_hp = $('.squirrel_hp');

            function handle_click() {
                $('#options').css("display", "none");
                $('#question').css("display", "none");
                $('#speechbubble').css("display", "none");
                $('#waiting').css("display", "block");
            }

            $option0.click(function(e) {
                socket.emit("game clicked", $option0.text());
                handle_click();
            });

            $option1.click(function(e) {
                socket.emit("game clicked", $option1.text());
                handle_click();
            });

            $option2.click(function(e) {
                socket.emit("game clicked", $option2.text());
                handle_click();
            });

            $option3.click(function(e) {
                socket.emit("game clicked", $option3.text());
                handle_click();
            });

            socket.on('new question', function(def, options, qid) {
                $('#waiting').css("display", "none");
                if (qid > 0){
                    $('#options').css("display", "none");
                    $('#question').css("display", "none");
                    $('#speechbubble').css("display", "none");
                    $('#result').css("display", "block");
                }
                $option0.text(options[0]);
                $option1.text(options[1]);
                $option2.text(options[2]);
                $option3.text(options[3]);
                $question.text(def);
            });

            socket.on('question result', function(result) {
                // if (result != "correct") $squirrel_hp.val($squirrel_hp.val() - 20);
                // else $point_hp.val($point_hp.val() - 10);
            });

            socket.on("stage", function(span_time, boss_hp, player_hp, de_boss, de_player, ans, num_correct, num_wrong){
                console.log("update stage")
                window.sessionStorage.setItem("time_str", span_time);
                // $squirrel_hp.val(player_hp);
                // $point_hp.val(boss_hp);
                clearInterval(downloadTimer);
                bounce_back();
                if(num_wrong == 0){
                    for (var i = 0; i < 3; i++) {
                        (function(last) { // IIFE to capture the value of last
                            if (i === 2) {
                            console.log("i = 2");
                            last = 1;
                            }

                            $('#pine').css("display", "block");
                            $('#pine').animate({
                            left: '+=220px',
                            bottom: '+=120px'
                            }, function() {
                            document.getElementById("pointhead_fig").animate([
                                { transform: "translate(1px, 1px) rotate(0deg)" },
                                { transform: "translate(-1px, -2px) rotate(-1deg)" },
                                { transform: "translate(-3px, 0px) rotate(1deg)" },
                                { transform: "translate(3px, 2px) rotate(0deg)" },
                                { transform: "translate(1px, -1px) rotate(1deg)" },
                                { transform: "translate(-1px, 2px) rotate(-1deg)" },
                                { transform: "translate(-3px, 1px) rotate(0deg)" },
                                { transform: "translate(3px, 1px) rotate(-1deg)" },
                                { transform: "translate(-1px, -1px) rotate(1deg)" },
                                { transform: "translate(1px, 2px) rotate(0deg)" },
                                { transform: "translate(1px, -2px) rotate(-1deg)" }
                            ], {
                                duration: 10,
                                iterations: 10,
                            });
                            if (last === 1) {
                                console.log("got in last = 1");
                                $point_hp.val(boss_hp);
                            }
                            });

                            $('#pine').fadeOut(20);
                            $('#pine').animate({
                            left: '-=220px',
                            bottom: '-=120px',
                            duration: '10000'
                            }, 'fast');
                            $('#pine').fadeIn(20);
                        })(0); // Pass the initial value of last (0)
                        }

                }
                else{
                    if(player_hp == 0){
                        num_correct = 0;
                    }
                    for (var i = 0; i < num_correct; i++) {
                        (function(last) { // IIFE to capture the value of last
                            if (i === num_correct - 1) {
                                last = 1;
                            }

                            $('#pine').css("display", "block");
                            $('#pine').animate({
                            left: '+=220px',
                            bottom: '+=120px'
                            }, function() {
                            document.getElementById("pointhead_fig").animate([
                                { transform: "translate(1px, 1px) rotate(0deg)" },
                                { transform: "translate(-1px, -2px) rotate(-1deg)" },
                                { transform: "translate(-3px, 0px) rotate(1deg)" },
                                { transform: "translate(3px, 2px) rotate(0deg)" },
                                { transform: "translate(1px, -1px) rotate(1deg)" },
                                { transform: "translate(-1px, 2px) rotate(-1deg)" },
                                { transform: "translate(-3px, 1px) rotate(0deg)" },
                                { transform: "translate(3px, 1px) rotate(-1deg)" },
                                { transform: "translate(-1px, -1px) rotate(1deg)" },
                                { transform: "translate(1px, 2px) rotate(0deg)" },
                                { transform: "translate(1px, -2px) rotate(-1deg)" }
                            ], {
                                duration: 10,
                                iterations: 10,
                            });
                            if (last === 1) {
                                console.log("got in last = 1");
                                $point_hp.val(boss_hp);
                            }
                            });

                            $('#pine').fadeOut(20);
                            $('#pine').animate({
                            left: '-=220px',
                            bottom: '-=120px',
                            duration: '10000'
                            }, 'fast');
                            $('#pine').fadeIn(20);
                        })(0); // Pass the initial value of last (0)
                    }
                    $('#pointhead_fig').delay(num_correct*800).animate(
                        
                        { deg: -90 },
                        {
                            duration: 200,
                            step: function(now) {
                                $(this).css({ transform: 'rotate(' + now + 'deg)' });
                            }
                        }
                    )
                    $('#pointhead_fig').animate({
                        right: '+=250px',
                        top: '+=200px',
                    }, function() {
                            document.getElementById("squirrel_fig").animate([
                            { transform: "translate(1px, 1px) rotate(0deg)" },
                            { transform: "translate(-1px, -2px) rotate(-1deg)" },
                            { transform: "translate(-3px, 0px) rotate(1deg)" },
                            { transform: "translate(3px, 2px) rotate(0deg)" },
                            { transform: "translate(1px, -1px) rotate(1deg)" },
                            { transform: "translate(-1px, 2px) rotate(-1deg)" },
                            { transform: "translate(-3px, 1px) rotate(0deg)" },
                            { transform: "translate(3px, 1px) rotate(-1deg)" },
                            { transform: "translate(-1px, -1px) rotate(1deg)" },
                            { transform: "translate(1px, 2px) rotate(0deg)" },
                            { transform: "translate(1px, -2px) rotate(-1deg)" }
                            ], {
                            duration: 10,
                            iterations: 10,
                            });
                            $squirrel_hp.val(player_hp);
                    })
                    
                    $('#pointhead_fig').animate({
                        right: '-=250px',
                        top: '-=200px',
                    })
                    $('#pointhead_fig').animate(
                        { deg:  360},
                        {
                            duration: 200,
                            step: function(now) {
                                $(this).css({ transform: 'rotate(' + now + 'deg)' });
                            }
                        }
                    )

                    
                }

                $("#ans").text(ans);
                $('#num_correct').text(num_correct);
                $('#num_wrong').text(num_wrong);
                $('#de_boss').text(de_boss);
                $('#de_player').text(de_player);
            })

            socket.on("game over", function(logFile, game_result, personal_best, all_best){
                window.sessionStorage.setItem("log_file", logFile);
                window.sessionStorage.setItem("Personal Best", personal_best);
                window.sessionStorage.setItem("All Best", all_best);
                $('#waiting').css("display", "none");
                $('#options').css("display", "none");
                $('#question').css("display", "none");
                $('#speechbubble').css("display", "none");
                $('#result').css("display", "block");
                setInterval(function(){
                    clearInterval();
                    if (game_result == 1)
                        window.location.href = "/lose_end";
                    else
                        window.location.href = "/win_end";
                }, 2600); // fit the time of bounce back
                
            });
        });
        // count down progress bar
        function start_countdown(){
            var counter = 10;
            downloadTimer = setInterval(
                function(){
                    counter -= 0.01;
                    document.getElementById("pbar").value = counter;
                    if(counter < 0){
                        clearInterval(downloadTimer);
                        socket.emit('timeout'); // penalty of timeout
                    }
                },
                1
            );
        }
        function bounce_back(){
            var counter = 0;
            var downloadTimer2 = setInterval(
                function(){
                    counter += 0.015; // 0.01
                    document.getElementById("pbar").value = counter;
                    if(counter >= 10){
                        clearInterval(downloadTimer2);
                        start_countdown();
                        $('#result').css("display", "none");
                        $('#options').css("display", "block");
                        $('#question').css("display", "block");
                        $('#speechbubble').css("display", "block");
                    }
                },
                1
            );
        }
        // stop watch
        let minute = 00;
        let second = 00;
        let count = 00;
        /*
        function stopWatch() {
            console.log("stopwatch")
            timer = true;
            if (timer) {
                count++;

                if (count == 100) {
                    second++;
                    count = 0;
                }

                if (second == 60) {
                    minute++;
                    second = 0;
                }

                let minString = minute;
                let secString = second;
                let countString = count;


                if (minute < 10) {
                    minString = "0" + minString;
                }

                if (second < 10) {
                    secString = "0" + secString;
                }

                if (count < 10) {
                    countString = "0" + countString;
                }

                document.getElementById('min').innerHTML = minString;
                document.getElementById('sec').innerHTML = secString;
                document.getElementById('count').innerHTML = countString;
                setTimeout(stopWatch, 10);
            }
        }
        */
    </script>
</body>
</html>